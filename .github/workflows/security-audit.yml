name: üõ°Ô∏è Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # S'ex√©cute tous les lundis √† minuit

permissions:
  contents: read
  security-events: write # Requis pour afficher les alertes dans l'onglet Security

jobs:
  # 1. Analyse des secrets (Cl√©s API, Mots de passe)
  trufflehog:
    name: üîë Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # N√©cessaire pour scanner tout l'historique Git

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified # Ne remonte que les cl√©s v√©rifi√©es si possible

  # 2. Analyse des d√©pendances PHP et JS
  dependencies-audit:
    name: üì¶ Dependencies Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check PHP Security (Composer)
        run: |
          composer audit
        # Note: 'composer audit' est natif depuis Composer 2.4

      - name: Check JS Security (NPM)
        run: npm audit --audit-level=high

  # 3. Analyse Statique du Code (CodeQL)
  codeql-analysis:
    name: üîç CodeQL Analysis (SAST)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript, php

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # 4. Scan des vuln√©rabilit√©s Laravel (Specific)
  laravel-security:
    name: üêò Laravel Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: Install Enlightn (Security Checker)
        run: |
          composer require --dev enlightn/enlightn
          # Ce scan v√©rifie les mauvaises configurations CSRF, Cookies, Headers, etc.
          # php artisan enlighten:security (n√©cessite config sp√©cifique)
